#include "oled.h"

uint8_t displayBuffer[4][128] = {0}; // Only use lower half (pages 4-7)

OLED::OLED(uint8_t height, I2C_Regs* I2C_PORT) : height_(height), I2C_PORT_(I2C_PORT) {}

bool OLED::begin() {

    writeCommand(0xAE);
    writeCommand(0xD5); writeCommand(0x80);
    writeCommand(0xA8); writeCommand(height_ == 32 ? 0x1F : 0x3F);
    writeCommand(0xD3); writeCommand(0x00);
    writeCommand(0x40); writeCommand(0x8D); writeCommand(0x14);
    writeCommand(0x20); writeCommand(0x00);
    writeCommand(0xA1); writeCommand(0xC8);
    writeCommand(0xDA); writeCommand(height_ == 32 ? 0x02 : 0x12);
    writeCommand(0x81); writeCommand(0xCF);
    writeCommand(0xD9); writeCommand(0xF1);
    writeCommand(0xDB); writeCommand(0x40);
    writeCommand(0xA4); writeCommand(0xA6); writeCommand(0xAF);

    clear();
    return true;
}

void OLED::writeCommand(uint8_t command) {
	uint8_t temp[2];
	temp[0] = 0x00;     // Command mode
	temp[1] = command;

	DL_I2C_fillControllerTXFIFO(I2C_PORT_, temp, 2);
	while (!(DL_I2C_getControllerStatus(I2C_PORT_) & DL_I2C_CONTROLLER_STATUS_IDLE));
	DL_I2C_startControllerTransfer(I2C_PORT_, OLED_ADDR, DL_I2C_CONTROLLER_DIRECTION_TX, 2);
	while (DL_I2C_getControllerStatus(I2C_PORT_) & DL_I2C_CONTROLLER_STATUS_BUSY_BUS);
	while (!(DL_I2C_getControllerStatus(I2C_PORT_) & DL_I2C_CONTROLLER_STATUS_IDLE));
	DL_I2C_flushControllerTXFIFO(I2C_PORT_);
}

void OLED::writeData(uint8_t data) {
  uint8_t temp[2];
  temp[0] = 0x40;     // Data mode
  temp[1] = data;

  DL_I2C_fillControllerTXFIFO(I2C_PORT_, temp, 2);
  while (!(DL_I2C_getControllerStatus(I2C_PORT_) & DL_I2C_CONTROLLER_STATUS_IDLE));
  DL_I2C_startControllerTransfer(I2C_PORT_, OLED_ADDR, DL_I2C_CONTROLLER_DIRECTION_TX, 2);
  while (DL_I2C_getControllerStatus(I2C_PORT_) & DL_I2C_CONTROLLER_STATUS_BUSY_BUS);
  while (!(DL_I2C_getControllerStatus(I2C_PORT_) & DL_I2C_CONTROLLER_STATUS_IDLE));
  DL_I2C_flushControllerTXFIFO(I2C_PORT_);
}

void OLED::setPixel(uint8_t x, uint8_t y, bool state) {
    if (x >= 128 || y < 32 || y >= 64) return;
    uint8_t page = (y - 32) / 8; // 仅用4页
    uint8_t bit = y % 8;

    if (state) {
        displayBuffer[page][x] |= (1 << bit);
    } else {
        displayBuffer[page][x] &= ~(1 << bit);
    }

    setCursor(x, page + 4);
    writeData(displayBuffer[page][x]);
}

void OLED::setCursor(uint8_t x, uint8_t y) {
    uint8_t lines = height_ == 32 ? 3 : 7;
    if (y > lines) y = lines;
    if (x > 127) x = 127;
    
    writeCommand(0xB0 + y); // Set page address
    writeCommand(0x00 | (x & 0x0F)); // Set lower column address
    writeCommand(0x10 | ((x & 0xF0) >> 4)); // Set higher column address
}

void OLED::updateBufferArea() {
    for (uint8_t page = 4; page < 8; page++) {
        setCursor(0, page);
        for (uint8_t col = 0; col < 128; col++) {
            writeData(displayBuffer[page - 4][col]);
        }
    }
}

void OLED::clear() {
    uint8_t i, j;
    uint8_t lines = 8;

    if (height_ == 32) {
        lines = 4;
    }

    for (i = 0; i < lines; i++) {
        setCursor(0, i);
        for (j = 0; j < 128; j++) {
            writeData(0x00);
        }
    }
    setCursor(0, 0);
}

void OLED::clearPart(uint8_t x1, uint8_t page1, uint8_t x2, uint8_t page2) {
    for (uint8_t i = page1; i < page2; i++) {
        setCursor(x1, i);
        for (uint8_t j = x1; j < x2; j++) {
            writeData(0x00);
            displayBuffer[i - 4][j] = 0;
        }
    }
    setCursor(x1, page1);
}

const uint8_t font6x8[][6] = {

	{ 0x00,0x00,0x00,0x00,0x00,0x00},//   0
	{ 0x00,0x00,0x00,0x2F,0x00,0x00},// ! 1
	{ 0x00,0x00,0x07,0x00,0x07,0x00},// " 2
	{ 0x00,0x14,0x7F,0x14,0x7F,0x14},// # 3
	{ 0x00,0x24,0x2A,0x7F,0x2A,0x12},// $ 4
	{ 0x00,0x23,0x13,0x08,0x64,0x62},// % 5
	{ 0x00,0x36,0x49,0x55,0x22,0x50},// & 6
	{ 0x00,0x00,0x00,0x07,0x00,0x00},// ' 7
	{ 0x00,0x00,0x1C,0x22,0x41,0x00},// ( 8
	{ 0x00,0x00,0x41,0x22,0x1C,0x00},// ) 9
	{ 0x00,0x14,0x08,0x3E,0x08,0x14},// * 10
	{ 0x00,0x08,0x08,0x3E,0x08,0x08},// + 11
	{ 0x00,0x00,0x00,0xA0,0x60,0x00},// , 12
	{ 0x00,0x08,0x08,0x08,0x08,0x08},// - 13
	{ 0x00,0x00,0x60,0x60,0x00,0x00},// . 14
	{ 0x00,0x20,0x10,0x08,0x04,0x02},// / 15
	{ 0x00,0x3E,0x51,0x49,0x45,0x3E},// 0 16
	{ 0x00,0x00,0x42,0x7F,0x40,0x00},// 1 17
	{ 0x00,0x42,0x61,0x51,0x49,0x46},// 2 18
	{ 0x00,0x21,0x41,0x45,0x4B,0x31},// 3 19
	{ 0x00,0x18,0x14,0x12,0x7F,0x10},// 4 20
	{ 0x00,0x27,0x45,0x45,0x45,0x39},// 5 21
	{ 0x00,0x3C,0x4A,0x49,0x49,0x30},// 6 22
	{ 0x00,0x01,0x71,0x09,0x05,0x03},// 7 23
	{ 0x00,0x36,0x49,0x49,0x49,0x36},// 8 24
	{ 0x00,0x06,0x49,0x49,0x29,0x1E},// 9 25
	{ 0x00,0x00,0x36,0x36,0x00,0x00},// : 26
	{ 0x00,0x00,0x56,0x36,0x00,0x00},// ; 27
	{ 0x00,0x08,0x14,0x22,0x41,0x00},// < 28
	{ 0x00,0x14,0x14,0x14,0x14,0x14},// = 29
	{ 0x00,0x00,0x41,0x22,0x14,0x08},// > 30
	{ 0x00,0x02,0x01,0x51,0x09,0x06},// ? 31
	{ 0x00,0x3E,0x49,0x55,0x59,0x2E},// @ 32
	{ 0x00,0x7C,0x12,0x11,0x12,0x7C},// A 33
	{ 0x00,0x7F,0x49,0x49,0x49,0x36},// B 34
	{ 0x00,0x3E,0x41,0x41,0x41,0x22},// C 35
	{ 0x00,0x7F,0x41,0x41,0x22,0x1C},// D 36
	{ 0x00,0x7F,0x49,0x49,0x49,0x41},// E 37
	{ 0x00,0x7F,0x09,0x09,0x09,0x01},// F 38
	{ 0x00,0x3E,0x41,0x49,0x49,0x7A},// G 39
	{ 0x00,0x7F,0x08,0x08,0x08,0x7F},// H 40
	{ 0x00,0x00,0x41,0x7F,0x41,0x00},// I 41
	{ 0x00,0x20,0x40,0x41,0x3F,0x01},// J 42
	{ 0x00,0x7F,0x08,0x14,0x22,0x41},// K 43
	{ 0x00,0x7F,0x40,0x40,0x40,0x40},// L 44
	{ 0x00,0x7F,0x02,0x0C,0x02,0x7F},// M 45
	{ 0x00,0x7F,0x04,0x08,0x10,0x7F},// N 46
	{ 0x00,0x3E,0x41,0x41,0x41,0x3E},// O 47
	{ 0x00,0x7F,0x09,0x09,0x09,0x06},// P 48
	{ 0x00,0x3E,0x41,0x51,0x21,0x5E},// Q 49
	{ 0x00,0x7F,0x09,0x19,0x29,0x46},// R 50
	{ 0x00,0x46,0x49,0x49,0x49,0x31},// S 51
	{ 0x00,0x01,0x01,0x7F,0x01,0x01},// T 52
	{ 0x00,0x3F,0x40,0x40,0x40,0x3F},// U 53
	{ 0x00,0x1F,0x20,0x40,0x20,0x1F},// V 54
	{ 0x00,0x3F,0x40,0x38,0x40,0x3F},// W 55
	{ 0x00,0x63,0x14,0x08,0x14,0x63},// X 56
	{ 0x00,0x07,0x08,0x70,0x08,0x07},// Y 57
	{ 0x00,0x61,0x51,0x49,0x45,0x43},// Z 58
	{ 0x00,0x00,0x7F,0x41,0x41,0x00},// [ 59
	{ 0x00,0x02,0x04,0x08,0x10,0x20},// \ 60
	{ 0x00,0x00,0x41,0x41,0x7F,0x00},// ] 61
	{ 0x00,0x04,0x02,0x01,0x02,0x04},// ^ 62
	{ 0x00,0x40,0x40,0x40,0x40,0x40},// _ 63
	{ 0x00,0x00,0x01,0x02,0x04,0x00},// ` 64
	{ 0x00,0x20,0x54,0x54,0x54,0x78},// a 65
	{ 0x00,0x7F,0x48,0x44,0x44,0x38},// b 66
	{ 0x00,0x38,0x44,0x44,0x44,0x20},// c 67
	{ 0x00,0x38,0x44,0x44,0x48,0x7F},// d 68
	{ 0x00,0x38,0x54,0x54,0x54,0x18},// e 69
	{ 0x00,0x08,0x7E,0x09,0x01,0x02},// f 70
	{ 0x00,0x18,0xA4,0xA4,0xA4,0x7C},// g 71
	{ 0x00,0x7F,0x08,0x04,0x04,0x78},// h 72
	{ 0x00,0x00,0x44,0x7D,0x40,0x00},// i 73
	{ 0x00,0x40,0x80,0x84,0x7D,0x00},// j 74
	{ 0x00,0x7F,0x10,0x28,0x44,0x00},// k 75
	{ 0x00,0x00,0x41,0x7F,0x40,0x00},// l 76
	{ 0x00,0x7C,0x04,0x18,0x04,0x78},// m 77
	{ 0x00,0x7C,0x08,0x04,0x04,0x78},// n 78
	{ 0x00,0x38,0x44,0x44,0x44,0x38},// o 79
	{ 0x00,0xFC,0x24,0x24,0x24,0x18},// p 80
	{ 0x00,0x18,0x24,0x24,0x18,0xFC},// q 81
	{ 0x00,0x7C,0x08,0x04,0x04,0x08},// r 82
	{ 0x00,0x48,0x54,0x54,0x54,0x20},// s 83
	{ 0x00,0x04,0x3F,0x44,0x40,0x20},// t 84
	{ 0x00,0x3C,0x40,0x40,0x20,0x7C},// u 85
	{ 0x00,0x1C,0x20,0x40,0x20,0x1C},// v 86
	{ 0x00,0x3C,0x40,0x30,0x40,0x3C},// w 87
	{ 0x00,0x44,0x28,0x10,0x28,0x44},// x 88
	{ 0x00,0x1C,0xA0,0xA0,0xA0,0x7C},// y 89
	{ 0x00,0x44,0x64,0x54,0x4C,0x44},// z 90
	{ 0x00,0x00,0x08,0x7F,0x41,0x00},// { 91
	{ 0x00,0x00,0x00,0x7F,0x00,0x00},// | 92
	{ 0x00,0x00,0x41,0x7F,0x08,0x00},// } 93
	{ 0x00,0x08,0x04,0x08,0x10,0x08} // ~ 94

};

const uint8_t font8x16[][16] = {

	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*" ",0*/
	{0x00,0x00,0x00,0xF8,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x11,0x1B,0x00,0x00,0x00},/*"!",1*/
	{0x00,0x00,0x78,0x08,0x00,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*""",2*/
	{0x00,0x40,0xE0,0x50,0x40,0xF0,0x50,0x40,0x00,0x04,0x1F,0x04,0x04,0x1F,0x04,0x00},/*"#",3*/
	{0x00,0xE0,0xB0,0x10,0xF8,0x10,0x10,0x00,0x00,0x10,0x10,0x7F,0x11,0x13,0x0E,0x00},/*"$",4*/
	{0x30,0x58,0x48,0x70,0x80,0x60,0x30,0x08,0x10,0x18,0x04,0x03,0x0C,0x12,0x12,0x0C},/*"%",5*/
	{0x00,0x60,0xF0,0x90,0x90,0x70,0x00,0x00,0x04,0x1F,0x11,0x11,0x16,0x1C,0x1F,0x10},/*"&",6*/
	{0x00,0x00,0x00,0x78,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"'",7*/
	{0x00,0x00,0x80,0xE0,0x30,0x08,0x00,0x00,0x00,0x00,0x07,0x3F,0x60,0xC0,0x00,0x00},/*"(",8*/
	{0x00,0x00,0x08,0x10,0xE0,0x80,0x00,0x00,0x00,0x00,0x80,0x60,0x38,0x0F,0x00,0x00},/*")",9*/
	{0x00,0x80,0xA0,0x60,0xD8,0x60,0x90,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00},/*"*",10*/
	{0x00,0x00,0x00,0xC0,0xC0,0x00,0x00,0x00,0x00,0x02,0x02,0x1F,0x1F,0x02,0x02,0x02},/*"+",11*/
	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x58,0x38,0x00,0x00,0x00},/*",",12*/
	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x02,0x02,0x02,0x00,0x00},/*"-",13*/
	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00},/*".",14*/
	{0x00,0x00,0x00,0x00,0xC0,0x70,0x18,0x00,0x00,0x20,0x18,0x06,0x01,0x00,0x00,0x00},/*"/",15*/
	{0x00,0xE0,0x30,0x10,0x10,0xB0,0xE0,0x80,0x00,0x0F,0x1A,0x13,0x11,0x18,0x0F,0x03},/*"0",16*/
	{0x00,0x60,0x20,0x30,0xF0,0x00,0x00,0x00,0x00,0x10,0x10,0x10,0x1F,0x10,0x10,0x00},/*"1",17*/
	{0x00,0x20,0x10,0x10,0x10,0xF0,0xE0,0x00,0x00,0x10,0x18,0x14,0x12,0x11,0x10,0x00},/*"2",18*/
	{0x00,0x10,0x10,0x10,0x10,0xF0,0x60,0x00,0x00,0x10,0x11,0x11,0x11,0x19,0x0E,0x00},/*"3",19*/
	{0x00,0x00,0x80,0x60,0x30,0xF0,0x00,0x00,0x04,0x07,0x05,0x04,0x04,0x1F,0x04,0x04},/*"4",20*/
	{0x00,0xF0,0xF0,0x10,0x10,0x10,0x10,0x00,0x00,0x11,0x11,0x11,0x11,0x19,0x0F,0x00},/*"5",21*/
	{0x00,0xC0,0x60,0x30,0x90,0x10,0x10,0x00,0x00,0x0F,0x19,0x11,0x10,0x11,0x0F,0x00},/*"6",22*/
	{0x00,0x10,0x10,0x10,0x10,0xD0,0x70,0x00,0x00,0x00,0x10,0x1C,0x07,0x01,0x00,0x00},/*"7",23*/
	{0x00,0x60,0xB0,0x90,0x10,0x90,0xE0,0x00,0x00,0x0E,0x12,0x11,0x11,0x13,0x0E,0x00},/*"8",24*/
	{0x00,0xE0,0x30,0x10,0x10,0x30,0xE0,0x00,0x00,0x11,0x11,0x12,0x12,0x09,0x07,0x00},/*"9",25*/
	{0x00,0x00,0x00,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00},/*":",26*/
	{0x00,0x00,0x00,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x40,0x58,0x38,0x00,0x00,0x00},/*";",27*/
	{0x00,0x00,0x00,0x80,0x80,0x40,0x00,0x00,0x00,0x02,0x03,0x05,0x08,0x18,0x10,0x00},/*"<",28*/
	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x05,0x05,0x05,0x05,0x05,0x05,0x00},/*"=",29*/
	{0x00,0x00,0x40,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x10,0x08,0x04,0x07,0x02,0x00},/*">",30*/
	{0x00,0x00,0x08,0x18,0x10,0xF0,0xE0,0x00,0x00,0x00,0x00,0x1B,0x01,0x00,0x00,0x00},/*"?",31*/
	{0x80,0xE0,0x10,0x88,0x88,0x88,0x10,0xE0,0x3F,0x60,0x8F,0x91,0x88,0x9F,0x08,0x0F},/*"@",32*/
	{0x00,0x00,0xC0,0x70,0x30,0xE0,0x00,0x00,0x10,0x1E,0x07,0x04,0x04,0x05,0x0F,0x18},/*"A",33*/
	{0x00,0xF0,0x10,0x10,0x10,0xB0,0xE0,0x00,0x00,0x1F,0x11,0x11,0x11,0x11,0x0E,0x00},/*"B",34*/
	{0x00,0xC0,0x20,0x10,0x10,0x10,0x10,0x00,0x00,0x0F,0x18,0x10,0x10,0x10,0x10,0x00},/*"C",35*/
	{0x00,0xF0,0x10,0x10,0x10,0x30,0xE0,0x80,0x00,0x1F,0x10,0x10,0x10,0x08,0x0F,0x03},/*"D",36*/
	{0x00,0xF0,0xF0,0x10,0x10,0x10,0x10,0x00,0x00,0x1F,0x1F,0x11,0x11,0x11,0x11,0x00},/*"E",37*/
	{0x00,0xF0,0xF0,0x10,0x10,0x10,0x10,0x00,0x00,0x1F,0x1F,0x01,0x01,0x01,0x01,0x00},/*"F",38*/
	{0x00,0xE0,0x20,0x10,0x10,0x10,0x10,0x00,0x01,0x0F,0x18,0x10,0x11,0x11,0x1F,0x00},/*"G",39*/
	{0x00,0xF0,0x00,0x00,0x00,0x00,0xF0,0x00,0x00,0x1F,0x01,0x01,0x01,0x01,0x1F,0x00},/*"H",40*/
	{0x00,0x10,0x10,0xF0,0xF0,0x10,0x10,0x00,0x00,0x10,0x10,0x1F,0x1F,0x10,0x10,0x00},/*"I",41*/
	{0x00,0x10,0x10,0x10,0x10,0xF0,0x00,0x00,0x00,0x18,0x10,0x10,0x10,0x0F,0x00,0x00},/*"J",42*/
	{0x00,0xF0,0x00,0x80,0x40,0x20,0x10,0x00,0x00,0x1F,0x01,0x03,0x06,0x0C,0x10,0x00},/*"K",43*/
	{0x00,0x00,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0x10,0x10,0x10,0x10,0x00},/*"L",44*/
	{0x00,0xF0,0x70,0x80,0x80,0xE0,0xF0,0xC0,0x1C,0x1F,0x00,0x03,0x03,0x00,0x03,0x1F},/*"M",45*/
	{0x00,0xF0,0x70,0xC0,0x00,0x00,0xF0,0x00,0x00,0x1F,0x00,0x01,0x07,0x1C,0x1F,0x00},/*"N",46*/
	{0x80,0xE0,0x30,0x10,0x10,0x10,0xE0,0xC0,0x03,0x0F,0x18,0x10,0x10,0x10,0x0F,0x07},/*"O",47*/
	{0x00,0xF0,0x10,0x10,0x10,0x30,0xE0,0x00,0x00,0x1F,0x02,0x02,0x02,0x01,0x01,0x00},/*"P",48*/
	{0x80,0xE0,0x30,0x10,0x10,0x10,0xE0,0xC0,0x03,0x0F,0x18,0x30,0x70,0x50,0x4F,0x47},/*"Q",49*/
	{0x00,0xF0,0xF0,0x10,0x10,0xB0,0xE0,0x00,0x00,0x1F,0x1F,0x01,0x03,0x0F,0x18,0x00},/*"R",50*/
	{0x00,0xE0,0xB0,0x10,0x10,0x10,0x10,0x00,0x00,0x10,0x10,0x11,0x11,0x13,0x0E,0x00},/*"S",51*/
	{0x00,0x10,0x10,0xF0,0xF0,0x10,0x10,0x10,0x00,0x00,0x00,0x1F,0x1F,0x00,0x00,0x00},/*"T",52*/
	{0x00,0xF0,0x00,0x00,0x00,0x00,0xF0,0x00,0x00,0x0F,0x18,0x10,0x10,0x10,0x0F,0x00},/*"U",53*/
	{0x10,0xF0,0x80,0x00,0x00,0x00,0xE0,0x30,0x00,0x00,0x07,0x1C,0x18,0x0F,0x01,0x00},/*"V",54*/
	{0x30,0xF0,0x00,0x00,0x80,0x00,0x00,0xF0,0x00,0x1F,0x1C,0x07,0x03,0x1C,0x1F,0x03},/*"W",55*/
	{0x00,0x30,0x60,0xC0,0x80,0x60,0x30,0x10,0x10,0x18,0x0C,0x03,0x03,0x0E,0x18,0x10},/*"X",56*/
	{0x10,0x70,0xC0,0x80,0x00,0xC0,0x60,0x10,0x00,0x00,0x00,0x1F,0x1F,0x01,0x00,0x00},/*"Y",57*/
	{0x00,0x10,0x10,0x10,0x90,0xD0,0x30,0x00,0x00,0x18,0x1C,0x13,0x11,0x10,0x10,0x00},/*"Z",58*/
	{0x00,0x00,0x00,0xF8,0x08,0x08,0x00,0x00,0x00,0x00,0x00,0xFF,0x80,0x80,0x00,0x00},/*"[",59*/
	{0x00,0x08,0x30,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x1C,0x30,0x00},/*"\",60*/
	{0x00,0x00,0x08,0x08,0xF8,0xF8,0x00,0x00,0x00,0x00,0x80,0x80,0xFF,0xFF,0x00,0x00},/*"]",61*/
	{0x00,0x80,0xC0,0x30,0x30,0x60,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"^",62*/
	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80},/*"_",63*/
	{0x00,0x00,0x08,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"`",64*/
	{0x00,0x00,0x40,0x40,0x40,0xC0,0x80,0x00,0x00,0x1C,0x12,0x12,0x12,0x0A,0x1F,0x00},/*"a",65*/
	{0x00,0xF8,0x80,0x40,0x40,0x40,0x80,0x00,0x00,0x1F,0x10,0x10,0x10,0x10,0x0F,0x00},/*"b",66*/
	{0x00,0x00,0x80,0x40,0x40,0x40,0x40,0x00,0x00,0x07,0x1D,0x10,0x10,0x10,0x10,0x00},/*"c",67*/
	{0x00,0x80,0xC0,0x40,0x40,0x40,0xF8,0x00,0x00,0x0F,0x18,0x10,0x10,0x08,0x1F,0x00},/*"d",68*/
	{0x00,0x80,0xC0,0x40,0x40,0x40,0x80,0x00,0x00,0x0F,0x1A,0x12,0x12,0x12,0x13,0x00},/*"e",69*/
	{0x00,0x80,0x80,0xF0,0x98,0x88,0x88,0x08,0x00,0x00,0x00,0x1F,0x00,0x00,0x00,0x00},/*"f",70*/
	{0x00,0x80,0xC0,0x40,0x40,0xC0,0xC0,0x40,0x00,0x6F,0x92,0x94,0x94,0x92,0x73,0x20},/*"g",71*/
	{0x00,0xF8,0x80,0x40,0x40,0x40,0x80,0x00,0x00,0x1F,0x00,0x00,0x00,0x00,0x1F,0x00},/*"h",72*/
	{0x00,0x40,0x40,0x58,0xD8,0x00,0x00,0x00,0x00,0x10,0x10,0x10,0x1F,0x10,0x10,0x00},/*"i",73*/
	{0x00,0x40,0x40,0x40,0x50,0xD8,0x00,0x00,0x00,0x80,0x80,0x80,0xC0,0x7F,0x00,0x00},/*"j",74*/
	{0x00,0xF8,0xF8,0x00,0x80,0x80,0x40,0x00,0x00,0x1F,0x1F,0x03,0x05,0x08,0x10,0x00},/*"k",75*/
	{0x00,0x08,0x08,0x08,0xF8,0x00,0x00,0x00,0x00,0x10,0x10,0x10,0x1F,0x10,0x10,0x00},/*"l",76*/
	{0x00,0xC0,0x40,0x40,0x80,0x40,0xC0,0x80,0x00,0x1F,0x00,0x00,0x1F,0x00,0x1F,0x1F},/*"m",77*/
	{0x00,0xC0,0x80,0x40,0x40,0x40,0x80,0x00,0x00,0x1F,0x00,0x00,0x00,0x00,0x1F,0x00},/*"n",78*/
	{0x00,0x80,0xC0,0x40,0x40,0x40,0x80,0x00,0x00,0x0F,0x18,0x10,0x10,0x10,0x0F,0x02},/*"o",79*/
	{0x00,0xC0,0x80,0x40,0x40,0x40,0x80,0x00,0x00,0xFF,0x10,0x10,0x10,0x10,0x0F,0x00},/*"p",80*/
	{0x00,0x80,0xC0,0x40,0x40,0x40,0xC0,0x00,0x00,0x0F,0x18,0x10,0x10,0x08,0xFF,0x00},/*"q",81*/
	{0x00,0xC0,0xC0,0x80,0x40,0x40,0xC0,0x00,0x00,0x1F,0x1F,0x00,0x00,0x00,0x01,0x01},/*"r",82*/
	{0x00,0x00,0xC0,0x40,0x40,0x40,0x40,0x00,0x00,0x10,0x13,0x12,0x12,0x16,0x0C,0x00},/*"s",83*/
	{0x40,0x40,0x40,0xF0,0x40,0x40,0x40,0x00,0x00,0x00,0x00,0x1F,0x10,0x10,0x10,0x00},/*"t",84*/
	{0x00,0xC0,0x00,0x00,0x00,0x00,0xC0,0x00,0x00,0x0F,0x18,0x10,0x10,0x08,0x1F,0x00},/*"u",85*/
	{0x00,0xC0,0x00,0x00,0x00,0x00,0xC0,0x40,0x00,0x01,0x07,0x1C,0x18,0x07,0x01,0x00},/*"v",86*/
	{0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0xC0,0x00,0x1F,0x18,0x07,0x07,0x1C,0x1F,0x01},/*"w",87*/
	{0x00,0x40,0xC0,0x00,0x00,0x80,0xC0,0x00,0x00,0x10,0x18,0x07,0x07,0x0D,0x18,0x00},/*"x",88*/
	{0x00,0xC0,0x00,0x00,0x00,0x00,0xC0,0x40,0x80,0x81,0xC7,0x7C,0x38,0x0F,0x01,0x00},/*"y",89*/
	{0x00,0x40,0x40,0x40,0x40,0xC0,0xC0,0x00,0x00,0x10,0x18,0x16,0x13,0x11,0x10,0x00},/*"z",90*/
	{0x00,0x00,0x00,0xF0,0x18,0x08,0x08,0x00,0x00,0x02,0x03,0x7F,0xC0,0x80,0x80,0x00},/*"{",91*/
	{0x00,0x00,0x00,0x00,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00},/*"|",92*/
	{0x00,0x00,0x08,0x18,0xF0,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0x7F,0x03,0x02,0x00},/*"}",93*/
	{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x01,0x01,0x02,0x04,0x06,0x03}/*"~",94*/

};

void OLED::printText(uint8_t x, uint8_t y, const char* str, uint8_t size) {
    while (*str) {
        if (*str == '\n') {
            x = 0;
            y += size;
            if (y >= height_) y = 0;
            setCursor(x, y);
        } else if (*str >= 0x20 && *str <= 0x7E) {
            uint8_t charIndex = *str - 0x20;
            if (size == 8) {
                // 6x8字体
                setCursor(x, y);
                for (uint8_t i = 0; i < 6; i++) {
                    writeData(font6x8[charIndex][i]);
                }
                x += 6;
            } else if (size == 16) {
                // 8x16字体
                for (uint8_t row = 0; row < 2; row++) {
                    setCursor(x, y + row);
                    for (uint8_t i = 0; i < 8; i++) {
                        writeData(font8x16[charIndex][row*8 + i]);
                    }
                }
                x += 8;
            }
            
            if (x >= 128) {
                x = 0;
                y += size;
                if (y >= height_) y = 0;
            }
        }
        str++;
    }
}

void OLED::printImage(uint8_t x, uint8_t y, uint8_t width, uint8_t height_, uint8_t* image) {
    for (uint8_t i = 0; i < height_; i++) {
        setCursor(x, y + i);
        for (uint8_t j = 0; j < width; j++) {
            writeData(image[i * width + j]);
        }
    }
}

void OLED::printVar(uint8_t x, uint8_t y, float num, const char* type, uint8_t length, bool zeroPad) {
    char buffer[16];
    if (zeroPad) {
        memset(buffer, '0', length);
    } else {
        memset(buffer, ' ', length);
    }
    
    if (strcmp(type, "int") == 0) {
        // 整数显示，右对齐
        int32_t value = (int32_t)num;
        char temp[16];
        ltoa(value, temp, 10);
        uint8_t len = strlen(temp);
        if (len > length) len = length;
        if (zeroPad && value < 0) {
            // 处理负数补零
            memcpy(buffer + (length - len + 1), temp + 1, len - 1);
            buffer[length - len] = '-';
        } else {
            memcpy(buffer + (length - len), temp, len);
        }
    } 
    else if (strcmp(type, "uint") == 0) {
        // 无符号整数显示，右对齐
        uint32_t value = (uint32_t)num;
        char temp[16];
        ltoa(value, temp, 10);
        uint8_t len = strlen(temp);
        if (len > length) len = length;
        memcpy(buffer + (length - len), temp, len);
    }
    else if (strcmp(type, "float") == 0) {
        // 浮点数显示，固定小数位数
        snprintf(buffer, sizeof(buffer), "%.2f", num);
        // 确保长度不超过指定值
        if (strlen(buffer) > length) {
            buffer[length] = '\0';
        }
    } 
    else if (strcmp(type, "hex") == 0) {
        // 十六进制显示，右对齐
        uint32_t value = (uint32_t)num;
        char temp[16];
        ltoa(value, temp, 16);
        uint8_t len = strlen(temp);
        if (len > length) len = length;
        memcpy(buffer + (length - len), temp, len);
    }
    
    buffer[length] = '\0';
    printText(x, y, buffer, 8);
}

void OLED::printHLine(uint8_t x, uint8_t y, uint8_t width) {
    setCursor(x, y);
    for (uint8_t i = 0; i < width; i++) {
        writeData(0xFF);
    }
}

// void OLED::printVLine(uint8_t x, uint8_t y, uint8_t height) {
//     for (uint8_t i = 0; i < height; i++) {
//         setPixel(x, y + i, true);
//     }
//     updateBufferArea();
// }

void OLED::lowBrightness(bool enable) {
    writeCommand(0x81);
    writeCommand(enable ? 0x10 : 0xCF);
}

void OLED::power(bool state) {
    writeCommand(state ? 0xAF : 0xAE);
}


